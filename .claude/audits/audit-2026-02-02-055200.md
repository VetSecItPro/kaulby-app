# Production Audit Report

**Date:** 2026-02-02 05:52:00 UTC
**Project:** kaulby-app
**Audited by:** Claude Production Audit (4-domain sweep)
**Domains:** Security | Database | Performance | Frontend/UX

---

## Executive Summary

| Severity | Count |
|----------|-------|
| CRITICAL | 2 |
| HIGH | 8 |
| MEDIUM | 10 |
| LOW | 8 |
| Auto-fixed | 0 |

**Overall Risk Level:** MEDIUM

---

## Domain Breakdown

| Domain | Critical | High | Medium | Low |
|--------|----------|------|--------|-----|
| Security | 1 | 2 | 2 | 3 |
| Database | 0 | 2 | 5 | 3 |
| Performance | 1 | 3 | 3 | 1 |
| Frontend/UX | 0 | 1 | 2 | 2 |

---

## CRITICAL

### FIX-001: Admin route bypasses auth in development mode
- **Domain:** Security
- **File:** `src/app/manage/layout.tsx:11`
- **Description:** /manage admin routes bypass auth when NODE_ENV=development. Unlike /dashboard which requires ALLOW_DEV_AUTH_BYPASS=true AND checks for Vercel, admin panel only checks isDev.
- **Remediation:** Add ALLOW_DEV_AUTH_BYPASS and !process.env.VERCEL checks matching /dashboard pattern.

### FIX-002: Module-level setInterval in rate-limit.ts runs in serverless
- **Domain:** Performance
- **File:** `src/lib/ai/rate-limit.ts:353`
- **Description:** setInterval(cleanupCache, 5min) at module level persists across Vercel warm invocations. Memory leak in production.
- **Remediation:** Guard with: `if (!process.env.VERCEL) { ... }`

---

## HIGH

### FIX-003: CSP allows unsafe-inline and unsafe-eval
- **Domain:** Security | `next.config.mjs:71`
- **Remediation:** Remove unsafe-eval after fixing lib/polar.ts dynamic import.

### FIX-004: Function constructor (eval equivalent) in polar.ts
- **Domain:** Security | `src/lib/polar.ts:45`
- **Remediation:** Replace with standard try/catch dynamic import.

### FIX-005: Missing index on results.isViewed
- **Domain:** Database | `src/lib/db/schema.ts:361`
- **Remediation:** Add index on isViewed and composite (isViewed, isHidden).

### FIX-006: Missing index on webhooks.isActive
- **Domain:** Database | `src/lib/db/schema.ts:496`
- **Remediation:** Add index on webhooks.isActive.

### FIX-007: Admin monitors page fetches all monitors without limit
- **Domain:** Performance | `src/app/manage/monitors/page.tsx:23`
- **Remediation:** Add .limit(100) or pagination.

### FIX-008: Admin dashboard queries all results without time filter
- **Domain:** Performance | `src/app/manage/page.tsx:103`
- **Remediation:** Add 30-day time filter to platformDistribution and sentimentBreakdown.

### FIX-009: setInterval in cache.ts without serverless guard
- **Domain:** Performance | `src/lib/cache.ts:265`
- **Remediation:** Guard with process.env.VERCEL check.

### FIX-010: Dynamic SEO routes missing generateMetadata
- **Domain:** Frontend | `src/app/tools/[slug]/page.tsx:1`
- **Remediation:** Add generateMetadata() to /tools/[slug] and /alternatives/[competitor].

---

## MEDIUM

### FIX-011: Missing UNIQUE on users.email
- **Domain:** Database | `src/lib/db/schema.ts:168`

### FIX-012: 87 console.log statements in production code
- **Domain:** Security | Multiple files

### FIX-013: Workspace role change needs authorization audit
- **Domain:** Security | `src/app/api/workspace/members/[memberId]/role/route.ts`

### FIX-014: API key rate limiting race condition
- **Domain:** Database | `src/lib/api-auth.ts:94`

### FIX-015: Crisis detection queries without limit
- **Domain:** Database | `src/lib/inngest/functions/crisis-detection.ts:119`

### FIX-016: Missing maxDuration on webhook/report routes
- **Domain:** Performance | `src/app/api/webhooks`

### FIX-017: Analytics page exceeds 200kB (251kB)
- **Domain:** Performance | `src/app/(dashboard)/dashboard/analytics/page.tsx`

### FIX-018: PWA theme color mismatch
- **Domain:** Frontend | `public/manifest.json:8`

### FIX-019: Marketing nav lacks active state
- **Domain:** Frontend | `src/components/shared/marketing-header.tsx:22`

### FIX-020: Missing composite index (leadScore, isViewed, isHidden)
- **Domain:** Database | `src/lib/db/schema.ts:376`

### FIX-021: Middleware checks Clerk config per-request
- **Domain:** Performance | `src/middleware.ts:76`

---

## LOW

### FIX-022: Email tracking allows metric spoofing
- **Domain:** Security | `src/app/api/track/open/route.ts`

### FIX-023: Inconsistent CASCADE on workspace FKs
- **Domain:** Database | `src/lib/db/schema.ts:178`

### FIX-024: No CHECK constraint on keywords array length
- **Domain:** Database | `src/lib/db/schema.ts:275`

### FIX-025: Admin actions lack audit logging
- **Domain:** Security | `src/app/manage/layout.tsx`

### FIX-026: rateLimitStore Map without size limit
- **Domain:** Performance | `src/lib/ai/rate-limit.ts:90`

### FIX-027: Icon-only buttons missing aria-label
- **Domain:** Frontend | `src/components/dashboard/responsive-results.tsx:273`

### FIX-028: GummySearch page missing metadata
- **Domain:** Frontend | `src/app/gummysearch/page.tsx`

---

## Checks Performed

### Security (12 categories)
- [x] Dependency vulnerabilities (2 high Next.js CVEs, 1 glob, 1 ESLint, 1 esbuild)
- [x] Secrets detection - CLEAN
- [x] Injection (SQL, XSS, command, path traversal, SSRF) - CLEAN
- [x] Authentication & authorization (every API route verified)
- [x] API security (rate limiting, input validation, CORS)
- [x] Security headers (CSP needs hardening)
- [x] Environment & configuration - CLEAN
- [x] Cryptography - CLEAN (Math.random only in non-security contexts)
- [x] Client-side security - CLEAN (no eval, safe localStorage usage)
- [x] Error handling & info disclosure - CLEAN
- [x] Business logic (race conditions, IDOR, privilege escalation)
- [x] Webhook security - CLEAN (HMAC + timingSafeEqual)

### Database (6 categories)
- [x] Schema analysis (constraints, defaults)
- [x] Index coverage (3 missing indexes found)
- [x] Query patterns (N+1, unbounded, injection)
- [x] Connection management - EXCELLENT
- [x] Data integrity (cascades, atomicity)
- [x] Migration safety

### Performance (8 categories)
- [x] Bundle analysis (1 page over 200kB)
- [x] Memory leaks (3 setInterval issues)
- [x] Unbounded queries (3 in admin pages)
- [x] Image optimization - CLEAN
- [x] Caching strategy - GOOD
- [x] Serverless configuration (missing maxDuration)
- [x] API design - EXCELLENT (no self-calls, good parallelization)
- [x] Middleware performance (per-request env check)

### Frontend/UX (8 categories)
- [x] SEO (robots, sitemap, OG - EXCELLENT; 3 pages missing metadata)
- [x] Accessibility (good overall, minor aria-label gaps)
- [x] HTML validity - CLEAN
- [x] Error handling & loading states - EXCELLENT
- [x] PWA & manifest (theme color mismatch)
- [x] Navigation & routing (missing active state)
- [x] Design consistency - GOOD
- [x] Cookie & privacy compliance - EXCELLENT

---

## Next Steps

1. Run `/sec-fix FIX-001` to fix critical admin auth bypass
2. Run `/sec-fix FIX-002` to fix critical serverless memory leak
3. Fix remaining HIGH issues (FIX-003 through FIX-010)
4. Run `/gh-feat` to push fixes

---

*Generated by Claude Production Audit*
