name: Security (Weekly)

on:
  schedule:
    # Sundays at 2am UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  issues: write  # Required for ZAP to create issue with findings

jobs:
  # All jobs run in parallel - no dependencies between them

  # Deep dependency audit
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Full npm audit
        run: |
          echo "### ðŸ”’ Weekly Dependency Audit" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit.json 2>/dev/null || true

          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit.json)

          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY

          # List vulnerable packages
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Packages needing attention:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "critical" or .value.severity == "high") | "\(.key): \(.value.severity)"' audit.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for outdated packages
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Outdated Packages" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm outdated 2>/dev/null || echo "All packages up to date"
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Semgrep deep scan (more rules than CI)
  semgrep-deep:
    name: Semgrep Deep Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Run Semgrep (extended rules)
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/default
            p/security-audit
            p/owasp-top-ten
            p/javascript
            p/typescript
            p/nextjs
            p/react
        env:
          SEMGREP_RULES: p/default p/security-audit p/owasp-top-ten p/javascript p/typescript p/nextjs p/react

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ” Semgrep Deep Scan" >> $GITHUB_STEP_SUMMARY
          echo "Extended ruleset: OWASP, JS/TS, Next.js, React" >> $GITHUB_STEP_SUMMARY

  # License compliance check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Check licenses
        run: |
          npm install -g license-checker
          echo "### ðŸ“œ License Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**License Summary:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          license-checker --summary 2>/dev/null || echo "License check completed"
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Check for problematic licenses
          echo "" >> $GITHUB_STEP_SUMMARY
          if license-checker --onlyAllow 'MIT;ISC;Apache-2.0;BSD-2-Clause;BSD-3-Clause;0BSD;CC0-1.0;Unlicense;CC-BY-4.0;Python-2.0' 2>/dev/null; then
            echo "âœ… All licenses compatible" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Review licenses above" >> $GITHUB_STEP_SUMMARY
          fi

  # OWASP ZAP DAST scan against production
  zap-scan:
    name: OWASP ZAP (DAST)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Create ZAP rules file
        run: |
          mkdir -p .zap
          cat > .zap/rules.tsv << 'EOF'
          10038	IGNORE	(Content Security Policy - handled by Vercel)
          10063	IGNORE	(Permissions Policy - handled by Vercel)
          EOF

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: 'https://kaulbyapp.com'
          rules_file_name: '.zap/rules.tsv'
          fail_action: false  # Don't fail workflow, just report

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ•·ï¸ OWASP ZAP DAST" >> $GITHUB_STEP_SUMMARY
          echo "Scanned: https://kaulbyapp.com" >> $GITHUB_STEP_SUMMARY
          echo "See artifacts for detailed report" >> $GITHUB_STEP_SUMMARY

      - name: Upload ZAP report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: zap-report
          path: report_html.html
          retention-days: 30
          if-no-files-found: ignore
