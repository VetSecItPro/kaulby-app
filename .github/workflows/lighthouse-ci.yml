name: Lighthouse CI - Performance Audit

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_OPTIONS: '--max_old_space_size=4096'

jobs:
  lighthouse:
    name: Lighthouse Mobile Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_APP_URL: http://localhost:3000
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_placeholder
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: /sign-in
          NEXT_PUBLIC_CLERK_SIGN_UP_URL: /sign-up
          NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: pk_test_placeholder
          NEXT_PUBLIC_POSTHOG_KEY: placeholder
          NEXT_PUBLIC_POSTHOG_HOST: https://us.posthog.com

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.13.x

      - name: Run Lighthouse CI
        id: lighthouse
        run: |
          # Start production server in background
          npm run start &
          SERVER_PID=$!

          # Wait for server to be ready
          echo "Waiting for server..."
          sleep 15

          # Run Lighthouse CI with mobile settings
          lhci autorun \
            --collect.settings.formFactor=mobile \
            --collect.settings.screenEmulation.mobile=true \
            --collect.settings.screenEmulation.width=375 \
            --collect.settings.screenEmulation.height=667 \
            --collect.settings.screenEmulation.deviceScaleFactor=2 \
            --collect.settings.throttling.rttMs=150 \
            --collect.settings.throttling.throughputKbps=1638 \
            --collect.settings.throttling.cpuSlowdownMultiplier=4 \
            --collect.url=http://localhost:3000/ \
            --collect.url=http://localhost:3000/sign-in \
            --collect.url=http://localhost:3000/pricing \
            --collect.numberOfRuns=1 \
            --upload.target=temporary-public-storage || true

          # Kill the server
          kill $SERVER_PID 2>/dev/null || true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEXT_PUBLIC_APP_URL: http://localhost:3000
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_placeholder

      - name: Generate Lighthouse Report Summary
        if: always()
        run: |
          echo "### ðŸ“± Lighthouse Mobile Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Device Emulation:** iPhone 8 (375x667 @ 2x)" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** Slow 4G (150ms RTT, 1.6Mbps)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d ".lighthouseci" ]; then
            echo "#### Performance Targets" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Target | Notes |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Performance Score | â‰¥70 | Core Web Vitals |" >> $GITHUB_STEP_SUMMARY
            echo "| Accessibility | â‰¥90 | WCAG compliance |" >> $GITHUB_STEP_SUMMARY
            echo "| Best Practices | â‰¥80 | Security headers, HTTPS |" >> $GITHUB_STEP_SUMMARY
            echo "| SEO | â‰¥90 | Meta tags, structure |" >> $GITHUB_STEP_SUMMARY
            echo "| First Contentful Paint | <2.5s | Initial render |" >> $GITHUB_STEP_SUMMARY
            echo "| Largest Contentful Paint | <4s | Main content |" >> $GITHUB_STEP_SUMMARY
            echo "| Total Blocking Time | <600ms | Interactivity |" >> $GITHUB_STEP_SUMMARY
            echo "| Cumulative Layout Shift | <0.25 | Visual stability |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š Full reports available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Lighthouse results not found (may have timed out)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Lighthouse Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci
          retention-days: 14

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## ðŸ“± Lighthouse Mobile Performance Audit\n\n';
            comment += '| Metric | Target |\n';
            comment += '|--------|--------|\n';
            comment += '| Performance | â‰¥70 |\n';
            comment += '| Accessibility | â‰¥90 |\n';
            comment += '| Best Practices | â‰¥80 |\n';
            comment += '| SEO | â‰¥90 |\n';
            comment += '| LCP | <4s |\n';
            comment += '| CLS | <0.25 |\n\n';
            comment += '*Full report in workflow summary and artifacts*\n\n';
            comment += 'ðŸ“² **Tested on:** iPhone 8 emulation (375x667, Slow 4G)';

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  # Accessibility audit
  accessibility:
    name: Accessibility Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_APP_URL: http://localhost:3000
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_placeholder
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: /sign-in
          NEXT_PUBLIC_CLERK_SIGN_UP_URL: /sign-up
          NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: pk_test_placeholder
          NEXT_PUBLIC_POSTHOG_KEY: placeholder
          NEXT_PUBLIC_POSTHOG_HOST: https://us.posthog.com

      - name: Install axe-core
        run: npm install -g @axe-core/cli

      - name: Run accessibility audit
        run: |
          echo "### â™¿ Accessibility Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Start server
          npm run start &
          sleep 15

          # Run axe on key pages
          echo "Running axe-core accessibility tests..." >> $GITHUB_STEP_SUMMARY

          axe http://localhost:3000/ --exit --tags wcag2a,wcag2aa || true
          axe http://localhost:3000/pricing --exit --tags wcag2a,wcag2aa || true

          pkill -f "next start" || true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Accessibility audit complete" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
