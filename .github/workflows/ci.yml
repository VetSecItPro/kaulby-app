name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  NODE_OPTIONS: '--max_old_space_size=4096'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Stage 1: Build (required, produces artifact)
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      build-success: ${{ steps.build.outcome == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        id: build
        run: npm run build
        env:
          NEXT_PUBLIC_APP_URL: http://localhost:3000
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: /sign-in
          NEXT_PUBLIC_CLERK_SIGN_UP_URL: /sign-up
          NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_POSTHOG_KEY: ${{ secrets.NEXT_PUBLIC_POSTHOG_KEY }}
          NEXT_PUBLIC_POSTHOG_HOST: https://us.posthog.com

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            .next
            !.next/cache
          retention-days: 1

  # ============================================
  # Stage 2: Parallel checks (no dependencies between them)
  # ============================================

  # Security - runs on ALL pushes (critical)
  security:
    name: Security
    runs-on: ubuntu-latest
    # No dependency on build - can run immediately in parallel

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: npm audit
        run: |
          echo "### ðŸ”’ Dependency Security" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit.json 2>/dev/null || true

          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit.json)

          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY

          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ Critical vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… No critical vulnerabilities" >> $GITHUB_STEP_SUMMARY

      - name: Secret detection
        run: |
          echo "### ðŸ”‘ Secret Scan" >> $GITHUB_STEP_SUMMARY
          FOUND=0

          # Stripe live keys
          if grep -rE "(sk_live_|pk_live_)[a-zA-Z0-9]{20,}" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null; then
            echo "âŒ Stripe live key in code!" >> $GITHUB_STEP_SUMMARY
            FOUND=1
          fi

          # AWS keys
          if grep -rE "AKIA[0-9A-Z]{16}" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null; then
            echo "âŒ AWS key in code!" >> $GITHUB_STEP_SUMMARY
            FOUND=1
          fi

          [ "$FOUND" -eq 1 ] && exit 1
          echo "âœ… No secrets detected" >> $GITHUB_STEP_SUMMARY

  # Semgrep SAST - runs on ALL pushes (fast, valuable)
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    # No dependency - runs in parallel with build

    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/default p/security-audit p/owasp-top-ten
        env:
          SEMGREP_RULES: p/default p/security-audit p/owasp-top-ten

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ” Semgrep SAST" >> $GITHUB_STEP_SUMMARY
          echo "Scanned: OWASP Top 10, security patterns" >> $GITHUB_STEP_SUMMARY

  # Code quality - no build dependency needed
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Analyze
        run: |
          echo "### ðŸ§¹ Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY

          CONSOLE=$(grep -rE "console\.(log|debug|info)" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null | wc -l || echo 0)
          echo "| console.log | $(echo $CONSOLE | tr -d ' ') |" >> $GITHUB_STEP_SUMMARY

          TODO=$(grep -rE "(TODO|FIXME):" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null | wc -l || echo 0)
          echo "| TODO/FIXME | $(echo $TODO | tr -d ' ') |" >> $GITHUB_STEP_SUMMARY

          TS_IGNORE=$(grep -rE "@ts-ignore|@ts-nocheck" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null | wc -l || echo 0)
          echo "| @ts-ignore | $(echo $TS_IGNORE | tr -d ' ') |" >> $GITHUB_STEP_SUMMARY

  # DB schema check - no build needed
  db-check:
    name: DB Schema
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Validate schema
        run: |
          echo "### ðŸ—„ï¸ Database Schema" >> $GITHUB_STEP_SUMMARY
          if [ -f "src/lib/db/schema.ts" ]; then
            npx tsc --noEmit src/lib/db/schema.ts 2>/dev/null && \
              echo "âœ… Schema valid" >> $GITHUB_STEP_SUMMARY || \
              echo "âŒ Schema errors" >> $GITHUB_STEP_SUMMARY
            TABLES=$(grep -c "pgTable" src/lib/db/schema.ts 2>/dev/null || echo 0)
            echo "Tables: $TABLES" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Stage 3: Post-build checks (need the artifact)
  # ============================================

  # Bundle analysis - needs build artifact
  bundle:
    name: Bundle Size
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Analyze
        run: |
          echo "### ðŸ“¦ Bundle Size" >> $GITHUB_STEP_SUMMARY
          if [ -d ".next/static/chunks" ]; then
            TOTAL=$(find .next/static/chunks -name "*.js" -exec cat {} \; | wc -c)
            KB=$((TOTAL / 1024))
            echo "**Total JS:** ${KB}KB" >> $GITHUB_STEP_SUMMARY

            if [ $KB -gt 750 ]; then
              echo "âŒ Exceeds 750KB budget" >> $GITHUB_STEP_SUMMARY
            elif [ $KB -gt 500 ]; then
              echo "âš ï¸ Exceeds 500KB mobile budget" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Within budget" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # ============================================
  # PR-only jobs (skip on push to main)
  # ============================================

  # Unit tests - PR only (add tests later)
  test:
    name: Tests
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Run tests
        run: |
          if npm run test --if-present 2>/dev/null; then
            echo "âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ No tests configured" >> $GITHUB_STEP_SUMMARY
          fi

  # Lighthouse - PR only (slow)
  lighthouse:
    name: Lighthouse
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Run Lighthouse
        run: |
          npm install -g @lhci/cli@0.13.x
          npm run start &
          sleep 15
          lhci autorun --collect.url=http://localhost:3000/ --collect.numberOfRuns=1 --upload.target=temporary-public-storage 2>&1 || true
          pkill -f "next start" || true
          echo "### ðŸ“± Lighthouse" >> $GITHUB_STEP_SUMMARY
          echo "Performance audit completed" >> $GITHUB_STEP_SUMMARY
        env:
          NEXT_PUBLIC_APP_URL: http://localhost:3000
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
