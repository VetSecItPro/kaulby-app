name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  NODE_OPTIONS: '--max_old_space_size=4096'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # All jobs run in PARALLEL (no dependencies)
  # ============================================

  # Build & Lint - core validation
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_APP_URL: http://localhost:3000
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: /sign-in
          NEXT_PUBLIC_CLERK_SIGN_UP_URL: /sign-up
          NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_POSTHOG_KEY: ${{ secrets.NEXT_PUBLIC_POSTHOG_KEY }}
          NEXT_PUBLIC_POSTHOG_HOST: https://us.posthog.com

      - name: Bundle size check
        run: |
          echo "### ðŸ“¦ Bundle Size" >> $GITHUB_STEP_SUMMARY
          if [ -d ".next/static/chunks" ]; then
            TOTAL=$(find .next/static/chunks -name "*.js" -exec cat {} \; | wc -c)
            KB=$((TOTAL / 1024))
            echo "**Total JS:** ${KB}KB" >> $GITHUB_STEP_SUMMARY
            if [ $KB -gt 750 ]; then
              echo "âŒ Exceeds 750KB budget" >> $GITHUB_STEP_SUMMARY
            elif [ $KB -gt 500 ]; then
              echo "âš ï¸ Exceeds 500KB mobile budget" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Within budget" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # Security - npm audit + secret scan
  security:
    name: Security
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: npm audit
        run: |
          echo "### ðŸ”’ Dependency Security" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit.json 2>/dev/null || true

          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit.json)

          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY

          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ Critical vulnerabilities!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… No critical vulnerabilities" >> $GITHUB_STEP_SUMMARY

      - name: Secret detection
        run: |
          echo "### ðŸ”‘ Secret Scan" >> $GITHUB_STEP_SUMMARY
          FOUND=0

          if grep -rE "(sk_live_|pk_live_)[a-zA-Z0-9]{20,}" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null; then
            echo "âŒ Stripe live key in code!" >> $GITHUB_STEP_SUMMARY
            FOUND=1
          fi

          if grep -rE "AKIA[0-9A-Z]{16}" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null; then
            echo "âŒ AWS key in code!" >> $GITHUB_STEP_SUMMARY
            FOUND=1
          fi

          [ "$FOUND" -eq 1 ] && exit 1
          echo "âœ… No secrets detected" >> $GITHUB_STEP_SUMMARY

  # Semgrep SAST - OWASP Top 10
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/owasp-top-ten
            p/security-audit

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ” Semgrep SAST" >> $GITHUB_STEP_SUMMARY
          echo "Scanned: OWASP Top 10, Security patterns" >> $GITHUB_STEP_SUMMARY

  # Code quality metrics
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Analyze
        run: |
          echo "### ðŸ§¹ Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY

          CONSOLE=$(grep -rE "console\.(log|debug|info)" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null | wc -l || echo 0)
          echo "| console.log | $(echo $CONSOLE | tr -d ' ') |" >> $GITHUB_STEP_SUMMARY

          TODO=$(grep -rE "(TODO|FIXME):" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null | wc -l || echo 0)
          echo "| TODO/FIXME | $(echo $TODO | tr -d ' ') |" >> $GITHUB_STEP_SUMMARY

          TS_IGNORE=$(grep -rE "@ts-ignore|@ts-nocheck" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null | wc -l || echo 0)
          echo "| @ts-ignore | $(echo $TS_IGNORE | tr -d ' ') |" >> $GITHUB_STEP_SUMMARY

  # DB schema validation
  db-check:
    name: DB Schema
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Validate schema
        run: |
          echo "### ðŸ—„ï¸ Database Schema" >> $GITHUB_STEP_SUMMARY
          if [ -f "src/lib/db/schema.ts" ]; then
            npx tsc --noEmit src/lib/db/schema.ts 2>/dev/null && \
              echo "âœ… Schema valid" >> $GITHUB_STEP_SUMMARY || \
              echo "âŒ Schema errors" >> $GITHUB_STEP_SUMMARY
            TABLES=$(grep -c "pgTable" src/lib/db/schema.ts 2>/dev/null || echo 0)
            echo "Tables: $TABLES" >> $GITHUB_STEP_SUMMARY
          fi

  # E2E Tests with Playwright (runs after build)
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build app
        run: npm run build
        env:
          NEXT_PUBLIC_APP_URL: http://localhost:3000
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: /sign-in
          NEXT_PUBLIC_CLERK_SIGN_UP_URL: /sign-up
          NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_POSTHOG_KEY: ${{ secrets.NEXT_PUBLIC_POSTHOG_KEY }}
          NEXT_PUBLIC_POSTHOG_HOST: https://us.posthog.com

      - name: Start server
        run: |
          npm run start &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Run E2E tests
        run: npx playwright test --project=chromium
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "### ðŸŽ­ E2E Tests" >> $GITHUB_STEP_SUMMARY
          if [ -f "playwright-report/index.html" ]; then
            echo "See artifacts for detailed report" >> $GITHUB_STEP_SUMMARY
          fi

  # Lighthouse Performance Audit
  lighthouse:
    name: Lighthouse
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Build app
        run: npm run build
        env:
          NEXT_PUBLIC_APP_URL: http://localhost:3000
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: /sign-in
          NEXT_PUBLIC_CLERK_SIGN_UP_URL: /sign-up
          NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL: /dashboard
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_POSTHOG_KEY: ${{ secrets.NEXT_PUBLIC_POSTHOG_KEY }}
          NEXT_PUBLIC_POSTHOG_HOST: https://us.posthog.com

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: ./lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Summary
        if: always()
        run: |
          echo "### ðŸš¦ Lighthouse Audit" >> $GITHUB_STEP_SUMMARY
          echo "Performance audit completed" >> $GITHUB_STEP_SUMMARY
